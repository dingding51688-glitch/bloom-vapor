<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Green Hub NI — Premium Products & 24/7 Pickup Lockers (UK)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2atLYB+g6JV+0ZKXHXTULyYM54PsTcZTa0m0kJ0=" crossorigin="" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j7k3P5LhY5QZnIcqoNCmieYw7YI6wrEn7k55m9A=" crossorigin=""></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Russo+One&display=swap');
    :root {
      color-scheme: light dark;
      /* Core backgrounds and surfaces */
      --bg: #0b0f14;
      --mid: #0f1418;
      --card-bg: rgba(18,22,26,0.72);
      --glass: rgba(255,255,255,0.04);
      /* Text */
      --text: #eef0ff;
      --muted: #aeb3d9;
      /* Brand accents */
      --accent-purple: #7c3aed;
      --accent-green: #10b981;
      --accent: var(--accent-purple);
      --accent-gradient: linear-gradient(120deg,var(--accent-purple),var(--accent-green));
      --shadow-accent: rgba(124,58,237,0.18);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Inter", "PingFang SC", "Microsoft YaHei", sans-serif;
    }
    body {
      background: radial-gradient(circle at top, #14171d, #06070a 60%);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 16px 12px 48px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding-top: env(safe-area-inset-top, 0px);
    }
    .pay-grid {
      display:flex;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .pay-option {
      flex:1 1 220px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-radius:12px;
      background:linear-gradient(145deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.06);
      text-align:left;
    }
    .pay-option strong {
      display:block;
      font-size:1rem;
    }
    .pay-option small {
      font-size:0.85rem;
      color:var(--muted);
    }
    .token-icon {
      width:38px;
      height:38px;
      border-radius:10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#fff;
      font-size:1rem;
    }
    .token-icon.tron { background:linear-gradient(145deg,#ff4d4f,#b41523); }
    .token-icon.eth { background:linear-gradient(145deg,#37b6ff,#1f81ff); }
    .token-icon.bank { background:linear-gradient(145deg,#fcd34d,#f59e0b); color:#101014; }
    .token-copy {
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    header {
      text-align: center;
      padding: 12px 0 8px;
      background: radial-gradient(circle at top, #14171d, #06070a 60%);
    }
    header .site-subtitle {
      display: block;
      margin-top: 6px;
      font-size: 0.95rem;
      color: #9ff3b3;
      opacity: 0.95;
      letter-spacing: 0.02em;
      font-weight: 600;
    }
    header h1 {
      font-size: clamp(2.2rem, 4vw, 3rem);
      margin-bottom: 12px;
    }
    header p {
      font-size: 1.05rem;
      color: #cfd3ff;
    }
    .hero {
      position: relative;
      overflow: hidden;
      background: var(--card-bg);
      background-image: radial-gradient(circle at 10% 20%, rgba(124,58,237,0.12), transparent 18%), radial-gradient(circle at 85% 10%, rgba(16,185,129,0.08), transparent 22%);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      padding: 32px;
      margin: 32px auto 36px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 24px;
      align-items: center;
      animation: fade-slide 0.8s ease both;
    }
    .hero::before,
    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.4;
    }
    .hero::before {
      background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.18), transparent 45%),
        radial-gradient(circle at 80% 10%, rgba(16, 185, 129, 0.12), transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(124, 58, 237, 0.14), transparent 55%);
      animation: particle-shift 12s ease-in-out infinite alternate;
    }
    .hero::after {
      background-image: radial-gradient(rgba(255, 255, 255, 0.12) 1px, transparent 1px);
      background-size: 40px 40px;
      animation: particle-drift 16s linear infinite;
      opacity: 0.3;
    }
    .hero > * {
      position: relative;
      z-index: 1;
    }
    .hero-text {
      flex: 1 1 320px;
      max-width: 880px;
      text-align: center;
    }
    .hero-text h2 {
      font-size: 1.8rem;
      margin-bottom: 12px;
    }
    .flow-step {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      margin-bottom: 12px;
      color: #cfd3ff;
    }
    .step-action {
      margin-left: 12px;
      background: var(--accent-gradient);
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 28px var(--shadow-accent);
      transition: transform 0.15s ease, opacity 0.15s ease, box-shadow 0.15s ease;
    }
    .step-action:hover { transform: translateY(-3px); opacity:0.98; }
    .hub-result.nearest {
      background: linear-gradient(90deg, rgba(124,58,237,0.06), rgba(16,185,129,0.03));
      border-left: 4px solid var(--accent);
      padding-left: 10px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.45);
    }
    /* Modal styles for hub picker */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 24px;
    }
    .modal.show { display: flex; }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(2,6,23,0.6);
      backdrop-filter: blur(2px);
    }
    .modal-content {
      position: relative;
      width: min(1100px, 96%);
      max-height: 80vh;
      overflow: auto;
      background: linear-gradient(180deg, rgba(12,14,18,0.9), rgba(16,18,22,0.95));
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.6);
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--text);
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer;
    }

    /* Ensure hub-panel is visible when placed inside modal */
    #modal-hub-container > .hub-panel {
      display: block !important;
    }
    /* Make hub-card stretch to modal width for a pleasant dialog */
    #modal-hub-container .hub-card {
      width: 100%;
      box-sizing: border-box;
    }
    .hero-text p {
      color: #e0e4ff;
    }
    .hero-cta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-left: auto;
    }
    .hero-cta button {
      border: none;
      border-radius: 999px;
      padding: 12px 22px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, opacity 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 12px 32px rgba(16,185,129,0.06);
    }
    .btn-primary {
      background: var(--accent-gradient);
      color: white;
      box-shadow: 0 10px 26px var(--shadow-accent);
    }
    .btn-outline {
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .hero-cta button:hover {
      transform: translateY(-4px) scale(1.02);
      opacity: 0.95;
      box-shadow: 0 14px 26px rgba(124, 58, 237, 0.35);
    }
    .section-title {
      font-size: 1.5rem;
      margin: 40px 0 20px;
      letter-spacing: 0.04em;
    }
    .category-grid, .product-grid {
      display: grid;
      gap: 18px;
    }
    .category-grid {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
    .product-grid {
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    .category-grid img {
      width: 100%;
      border-radius: 14px;
      height: 170px;
      object-fit: cover;
      margin-bottom: 12px;
      filter: brightness(0.95);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .product-showcase {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 18px;
      max-width: 1100px;
      margin: 0 auto;
      align-items: start;
    }
    .card, .product-card {
      animation: fade-slide 0.9s ease both;
    }
    /* Product card — premium styling */
    .product-card {
      padding: 24px;
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(22,24,34,0.96), rgba(10,12,18,0.98));
      border: 1px solid rgba(124, 58, 237, 0.08);
      box-shadow: 0 20px 45px rgba(2,6,12,0.65), 0 6px 20px rgba(124,58,237,0.06);
      display: flex;
      flex-direction: column;
      gap: 14px;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      height: 100%;
      min-height: 520px;
    }
    .product-card:hover { transform: translateY(-8px); box-shadow: 0 30px 70px rgba(3,6,12,0.75), 0 18px 40px rgba(124,58,237,0.12); }
    .product-card img {
      width: 100%;
      border-radius: 14px;
      height: 170px;
      object-fit: cover;
      margin-bottom: 6px;
      border: 1px solid rgba(255,255,255,0.04);
      box-shadow: 0 8px 24px rgba(2,6,12,0.6);
      transform-origin: center;
      transition: transform 0.32s ease, box-shadow 0.32s ease;
    }
    .product-gallery {
      width: 100%;
      position: relative;
      overflow: hidden;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 12px 30px rgba(0,0,0,0.45);
      margin-bottom: 10px;
      background: linear-gradient(160deg, rgba(10,12,20,0.95), rgba(16,20,30,0.85));
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 220px;
    }
    .product-gallery img {
      width: 100%;
      height: auto;
      max-height: 260px;
      object-fit: contain;
      border-radius: 0;
      margin-bottom: 0;
      border: none;
      box-shadow: none;
      transition: opacity 0.3s ease;
    }
    .product-gallery-thumbs {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .product-gallery-thumb {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid transparent;
      flex-shrink: 0;
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.2s ease;
    }
    .product-gallery-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      margin: 0;
    }
    .product-gallery-thumb.active {
      border-color: rgba(130,245,178,0.9);
      box-shadow: 0 0 12px rgba(130,245,178,0.35);
      transform: translateY(-2px);
    }
    .product-card:hover img { transform: scale(1.03); box-shadow: 0 18px 40px rgba(2,6,12,0.75); }
    .product-card p { color: #dbe0ff; }
    .stardawg-title, .product-card h4 {
      font-family: 'Russo One', 'Bebas Neue', 'Orbitron', sans-serif;
      font-size: 1.18rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: #f6f7ff;
      text-shadow: 0 2px 18px rgba(124, 58, 237, 0.18);
      margin-bottom: 6px;
    }
    .stardawg-title .inline-flag { width: 28px; height: 18px; border-radius: 4px; box-shadow: 0 6px 18px rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.12); object-fit: cover; }

    /* Variant table — elevated, compact and refined */
    .variant-table {
      width: 100%;
      margin-top: 12px;
      border-collapse: collapse;
      font-size: 0.95rem;
      background: linear-gradient(180deg, rgba(8,10,14,0.6), rgba(6,8,12,0.5));
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.04);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02), 0 12px 30px rgba(2,6,12,0.45);
    }
    .variant-table th,
    .variant-table td {
      padding: 12px 16px;
      text-align: left;
      vertical-align: middle;
    }
    .variant-table thead {
      background: linear-gradient(90deg, rgba(124,58,237,0.26), rgba(124,58,237,0.14));
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.82rem;
      color: #eef0ff;
      font-weight: 700;
    }
    .variant-table tbody tr {
      cursor: pointer;
      transition: background 0.18s ease, transform 0.12s ease;
      will-change: transform;
    }
    .variant-table tbody tr:not(:last-child) { border-bottom: 1px solid rgba(255,255,255,0.03); }
    .variant-table tbody tr:hover,
    .variant-table tbody tr:focus { background: linear-gradient(90deg, rgba(124,58,237,0.06), rgba(124,58,237,0.03)); transform: translateY(-2px); }
    .variant-table td:nth-child(2), .variant-table td:nth-child(3) { text-align: right; }
    .variant-table .price-cell {
      font-weight: 800;
      color: #ffffff;
      font-size: 1.05rem;
      letter-spacing: 0.02em;
      padding-right: 6px;
    }
    .variant-table td small { color: #9ba3d8; font-size: 0.86rem; }
    .variant-table .per-gram { color: #9aa7d6; font-size: 0.88rem; }

    .variant-cards {
      display: none;
      gap: 12px;
      margin-top: 12px;
      overflow-x: auto;
      padding-bottom: 4px;
      scroll-snap-type: x mandatory;
    }
    .variant-card {
      min-width: 150px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(145deg, rgba(21,23,31,0.95), rgba(10,12,18,0.9));
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
      scroll-snap-align: start;
    }
    .variant-card-label {
      font-weight: 700;
      letter-spacing: 0.05em;
      font-size: 0.92rem;
      color: #f5f6ff;
    }
    .variant-card-price {
      font-size: 1.1rem;
      font-weight: 800;
      color: #ffffff;
    }
    .variant-card-per {
      font-size: 0.9rem;
      color: #9db0ff;
    }
    .variant-card:hover {
      transform: translateY(-2px);
      border-color: rgba(124,58,237,0.5);
      box-shadow: 0 12px 24px rgba(0,0,0,0.45);
    }
    .variant-card.active {
      border-color: rgba(130,245,178,0.8);
      box-shadow: 0 0 20px rgba(130,245,178,0.35);
    }
    .product-flag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      font-size: 0.85rem;
      color: #f5f5ff;
      margin-bottom: 10px;
    }
    .hub-panel {
      margin: 18px auto 10px;
      display: none;
      max-width: 1100px;
    }
    .hub-panel.active {
      display: block;
    }
    .hub-card {
      background: rgba(15, 17, 25, 0.9);
      border-radius: 18px;
      padding: 18px 24px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: transform 0.6s ease;
    }
    .hub-panel.active .hub-card {
      animation: float 6s ease-in-out infinite;
    }
    .order-section {
      margin-top: 56px;
      padding: 32px;
      border-radius: 22px;
      background: rgba(12, 14, 22, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 25px 45px rgba(0, 0, 0, 0.45);
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
    }
    .order-section .section-title {
      margin-top: 0;
    }
    .order-desc,
    .order-hint {
      color: #cfd3ff;
      margin-bottom: 18px;
    }
    .order-hint {
      font-size: 0.95rem;
      opacity: 0.9;
    }
    .order-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      margin-bottom: 16px;
    }
    .order-form label {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.95rem;
      color: #e4e6ff;
    }
    .order-form .full-width {
      grid-column: 1 / -1;
    }
    .order-form input,
    .order-form textarea {
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(17, 19, 28, 0.85);
      color: #fff;
      font-size: 1rem;
      transition: border-color 0.2s ease, transform 0.2s ease;
    }
    .order-form input:focus,
    .order-form textarea:focus {
      border-color: var(--accent);
      outline: none;
      transform: translateY(-2px);
    }
    .order-form textarea {
      resize: vertical;
      min-height: 120px;
    }
    .submit-order {
      grid-column: 1 / -1;
      border: none;
      border-radius: 18px;
      padding: 14px 20px;
      font-size: 1.05rem;
      font-weight: 600;
      background: linear-gradient(120deg, var(--accent), #a855f7);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 15px 30px rgba(124, 58, 237, 0.35);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .submit-order:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 35px rgba(124, 58, 237, 0.45);
    }
    .hub-map {
      margin-top: 16px;
      height: 290px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: none;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.45);
      transition: transform 0.5s ease, opacity 0.5s ease;
      transform: translateY(12px);
      opacity: 0;
    }
    .hub-map.visible {
      display: block;
      transform: translateY(0);
      opacity: 1;
    }
    .hub-map.visible {
      display: block;
    }
    .stations-section {
      margin-top: 40px;
    }
    .station-controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin: 0 0 16px 0;
    }
    .station-controls input {
      flex: 1;
      min-width: 240px;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.2);
      color: var(--text);
    }
    .station-count {
      font-size: 0.9rem;
      color: #9ba3d8;
    }
    .station-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
      max-height: 520px;
      overflow-y: auto;
      padding-right: 6px;
    }
    .station-list .station-card {
      background: rgba(15, 17, 25, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      animation: fade-slide 0.4s ease both;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }
    .station-card:hover {
      transform: translateY(-6px);
      border-color: rgba(124, 58, 237, 0.45);
    }
    .station-card small {
      color: #8de1ff;
      font-weight: 600;
      letter-spacing: 0.04em;
    }
    .station-card p {
      color: #d7ddff;
      font-size: 0.95rem;
    }
    .station-card span {
      color: #9ba3d8;
      font-size: 0.85rem;
    }
    .skeleton-line {
      width: 100%;
      height: 14px;
      border-radius: 999px;
      background: linear-gradient(120deg, rgba(255,255,255,0.08) 25%, rgba(255,255,255,0.18) 50%, rgba(255,255,255,0.08) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.3s infinite;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    @keyframes float {
      0% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
      100% { transform: translateY(0); }
    }
    @keyframes particle-shift {
      0% { transform: translate3d(0, 0, 0); }
      100% { transform: translate3d(20px, -10px, 0); }
    }
    @keyframes particle-drift {
      0% { background-position: 0 0; }
      100% { background-position: 200px 200px; }
    }
    .hub-card ul {
      list-style: none;
      margin: 12px 0;
      padding-left: 0;
      color: #ced4ff;
    }
    .hub-card li {
      margin-bottom: 6px;
    }
    .hub-result {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      padding: 6px 0;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .hub-result:hover {
      color: #ffffff;
    }
    .select-chip {
      font-size: 0.85rem;
      color: #82f5b2;
      border: 1px solid rgba(130, 245, 178, 0.4);
      border-radius: 999px;
      padding: 2px 10px;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .hub-result:hover .select-chip {
      background: rgba(130, 245, 178, 0.15);
      color: #e7fff3;
    }
    .highlight-pulse {
      animation: glow 2s ease-out 1;
    }
    @keyframes glow {
      0% { box-shadow: 0 0 0 rgba(124, 58, 237, 0.6); }
      50% { box-shadow: 0 0 40px rgba(130, 245, 178, 0.7); }
      100% { box-shadow: 0 0 0 rgba(124, 58, 237, 0); }
    }
        .hub-form {
      margin-bottom: 14px;
    }
    .hub-form label {
      display: block;
      font-size: 0.9rem;
      color: #9ba3d8;
      margin-bottom: 6px;
    }
    .hub-form-row {
      display: flex;
      gap: 8px;
    }
    .hub-form-row input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.2);
      color: #f4f5ff;
    }
    .hub-form-row button {
      border: none;
      background: var(--accent);
      color: white;
      padding: 0 18px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .hub-note {
      color: #9ba3d8;
      font-size: 0.9rem;
    }
    .distance {
      color: #8de1ff;
      font-weight: 600;
      margin-left: 8px;
    }
    .card {
      background: rgba(15, 17, 25, 0.9);
      border-radius: 18px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.35);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chip {
      display: inline-block;
      padding: 3px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      background: rgba(124, 58, 237, 0.15);
      color: #c4b5fd;
    }
    .price {
      font-size: 1.7rem;
      font-weight: 600;
    }
    .buy-btn {
      margin-top: auto;
      border: none;
      background: var(--accent);
      color: white;
      border-radius: 14px;
      padding: 10px 0;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 8px 18px rgba(124, 58, 237, 0.35);
    }
    .buy-btn:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 14px 30px rgba(124, 58, 237, 0.45);
    }
    footer {
      margin-top: 50px;
      text-align: center;
      font-size: 0.9rem;
      color: #9aa1c8;
    }
    footer a {
      color: #c4b5fd;
      text-decoration: none;
    }
    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 36px;
      padding-bottom: 18px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      position: sticky;
      top: env(safe-area-inset-top, 0px);
      z-index: 10;
      backdrop-filter: blur(14px);
      background: rgba(8, 9, 13, 0.85);
    }
    .logo-mark {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      font-size: 1.15rem;
      letter-spacing: 0.06em;
      text-transform: none;
      font-weight: 700;
    }
    .logo-link { display:inline-flex; align-items:center; gap:12px; text-decoration:none; color:inherit; }
    .logo-icon {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      background: linear-gradient(135deg,#7c3aed 0%, #10b981 100%);
      border: 1px solid rgba(255, 255, 255, 0.06);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 22px rgba(2,6,23,0.6);
      flex-shrink: 0;
    }
    .logo-icon svg {
      width: 26px;
      height: 26px;
    }
    /* larger logo image (uses uploads/logo.svg) */
    .logo-icon img, .logo-img { width: 350px; height: 70px; object-fit: contain; border-radius: 8px; display:block; }
    /* Responsive: scale down logo on small screens */
    @media (max-width: 720px) {
      nav {
        padding: 6px 12px 16px;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        position: static;
        top: auto;
      }
      #stations { display: none; }
      .logo-link {
        width: 100%;
        justify-content: center;
      }
      .logo-icon {
        width: auto;
        height: auto;
        padding: 6px 14px;
        border-radius: 14px;
        box-shadow: 0 8px 18px rgba(0,0,0,0.55);
      }
      .logo-icon img, .logo-img { width: min(220px, 70vw); height: auto; }
      .nav-menu {
        width: 100%;
        justify-content: center;
        gap: 18px;
        flex-wrap: wrap;
      }
      .nav-indicator { display: none; }
      nav { padding-bottom: 12px; }
      .variant-table { display: none; }
      .variant-cards { display: flex; }
    }
    nav { display:flex; align-items:center; justify-content:space-between; padding:6px 0; }
    .logo-link { display:flex; align-items:center; gap:12px; }
    .nav-menu { display:flex; gap:22px; align-items:center; }
    .sr-only { position: absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    .logo-part { color: #e7f1ff; font-weight: 800; font-size:1.05rem; }
    .logo-part.mid { color: #82f5b2; }
    .logo-part.sm { color: #cfeee0; font-weight:700; font-size:0.85rem; margin-left:6px; opacity:0.95; }
    .logo-num { color: var(--accent); font-weight: 700; }
    .logo-dot { color: #ffcc5c; font-weight: 700; }
    .nav-menu {
      display: flex;
      gap: 26px;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      position: relative;
    }
    .nav-indicator {
      display: none;
    }
    .nav-menu a {
      text-decoration: none;
      color: #dfe2ff;
      padding-bottom: 6px;
      border-bottom: 2px solid transparent;
      transition: color 0.2s ease, border-color 0.2s ease;
    }
    .nav-menu a:hover,
    .nav-menu a.active {
      color: #ffffff;
      border-color: var(--accent);
    }
    @keyframes fade-slide {
      0% {
        opacity: 0;
        transform: translateY(15px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @media (max-width: 640px) {
      .hero {
        padding: 24px;
      }
      .hero-cta {
        width: 100%;
      }
      .hero-cta button {
        flex: 1;
        justify-content: center;
      }
      .station-list {
        max-height: none;
      }
    }
    /* Floating contact buttons (bottom-right) */
    #floating-contact {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 1400;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      pointer-events: auto;
    }
    .fc-label {
      background: rgba(255,255,255,0.03);
      color: #e6f7ec;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.95rem;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.04);
      backdrop-filter: blur(4px);
    }
    .fc-button {
      width: 52px;
      height: 52px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, #2b3138, #101316);
      box-shadow: 0 8px 22px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.06);
      text-decoration: none;
      transition: transform 0.14s ease, box-shadow 0.14s ease;
    }
    .fc-button:focus { outline: 2px solid rgba(130,245,178,0.18); transform: translateY(-3px); }
    .fc-button:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(2,6,23,0.7); }
    .fc-icon { width: 22px; height: 22px; }
    .fc-img { width: 22px; height: 22px; object-fit: contain; display:block }
    @media (max-width:480px){
      #floating-contact{ right: 12px; bottom: 12px; }
      .fc-button{ width:44px;height:44px }
      .fc-icon{ width:18px;height:18px }
    }

    /* Product image modal */
    .img-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1600;
    }
    .img-modal.show { display: flex; }
    .img-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(5,7,12,0.85);
      backdrop-filter: blur(4px);
    }
    .img-modal-content {
      position: relative;
      max-width: min(90vw, 720px);
      max-height: min(90vh, 720px);
      padding: 12px;
      border-radius: 18px;
      background: rgba(11,14,20,0.95);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 30px 60px rgba(0,0,0,0.65);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 2;
    }
    .img-modal-content img {
      width: 100%;
      height: auto;
      border-radius: 12px;
      object-fit: contain;
    }
    .img-modal-caption {
      color: #e4e8ff;
      font-weight: 600;
      text-align: center;
      font-size: 1rem;
    }
    .img-modal-close {
      position: absolute;
      top: 6px;
      right: 6px;
      border: none;
      background: rgba(0,0,0,0.35);
      color: #fff;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div class="container" id="top">
    <nav>
      <div class="logo-mark">
        <a class="logo-link" href="#top" aria-label="Green Hub NI home">
          <div class="logo-icon" aria-hidden="true">
            <img src="uploads/logo.png" alt="Green Hub Northern Ireland" class="logo-img" loading="lazy" />
          </div>
          <span class="sr-only">Green Hub Northern Ireland</span>
        </a>
      </div>
      <div class="nav-menu" id="nav-menu">
        <span class="nav-indicator" id="nav-indicator"></span>
        <a href="#top" class="active">Home</a>
        <a href="#products">Products</a>
        <a href="#stations">All hubs</a>
      </div>
    </nav>

    <header>
      <h1>Green Hub Northern Ireland</h1>
      <span class="site-subtitle">Same-Day Order &amp; Collection</span>
    </header>

    

    <section class="how-it-works" id="how">
      <h3 class="section-title">How It Works</h3>
      <!--
        Replace the four image files below with the icons you provided.
        Place the files in the repository at: uploads/how-step-1.png ... uploads/how-step-4.png
        If you only have two image files, upload them and name them accordingly, or update the src paths.
      -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:12px;">
        <div class="card" style="text-align:center;">
          <picture>
            <source srcset="uploads/how-step-1.png" type="image/png">
            <img src="uploads/how-step-1.svg" alt="Place your order" style="width:84px;height:auto;margin:6px auto 8px;display:block;" loading="lazy" />
          </picture>
          <h4 style="margin:8px 0 4px;">Place your order</h4>
          <p style="font-size:0.95rem;margin:0;color:#cfd3ff;">Choose items and complete checkout online.</p>
        </div>
        <div class="card" style="text-align:center;">
          <picture>
            <source srcset="uploads/how-step-2.png" type="image/png">
            <img src="uploads/how-step-2.svg" alt="Receive pickup code" style="width:84px;height:auto;margin:6px auto 8px;display:block;" loading="lazy" />
          </picture>
          <h4 style="margin:8px 0 4px;">Receive your pickup code</h4>
          <p style="font-size:0.95rem;margin:0;color:#cfd3ff;">We’ll send a unique, secure code to your phone or email.</p>
        </div>
        <div class="card" style="text-align:center;">
          <picture>
            <source srcset="uploads/how-step-3.png" type="image/png">
            <img src="uploads/how-step-3.svg" alt="Go to smart locker" style="width:84px;height:auto;margin:6px auto 8px;display:block;" loading="lazy" />
          </picture>
          <h4 style="margin:8px 0 4px;">Go to the smart locker and enter your code</h4>
          <p style="font-size:0.95rem;margin:0;color:#cfd3ff;">Visit the hub shown on your confirmation and enter the code at the locker.</p>
        </div>
        <div class="card" style="text-align:center;">
          <picture>
            <source srcset="uploads/how-step-4.png" type="image/png">
            <img src="uploads/how-step-4.svg" alt="Collect your item" style="width:84px;height:auto;margin:6px auto 8px;display:block;" loading="lazy" />
          </picture>
          <h4 style="margin:8px 0 4px;">Collect your item</h4>
          <p style="font-size:0.95rem;margin:0;color:#cfd3ff;">Retrieve your parcel from the locker — contactless and secure.</p>
        </div>
      </div>
      
    </section>

    <h3 class="section-title" id="products">Select Your Product</h3>
    <div id="product-showcase" class="product-showcase" aria-live="polite">
      <!-- Products will be rendered here from data/products.json -->
    </div>

    
    <div class="hub-panel" id="hub-panel">
      <div class="hub-card">
        <div class="hub-form">
          <label for="postcode">Postcode</label>
          <div class="hub-form-row">
            <input type="text" id="postcode" placeholder="Enter postcode" />
            <button type="button" onclick="matchHub()">Find hubs</button>
          </div>
        </div>
        <ul id="hub-list">
          <li>Enter a postcode to discover nearby 24/7 pickup hubs.</li>
        </ul>
        <div id="hub-map" class="hub-map" role="presentation" aria-hidden="true"></div>
        <p class="hub-note">Showing available 24/7 pickup hubs. Enter your postcode to find the closest locations.</p>
      </div>
    </div>

    <!-- Modal for hub picker (will temporarily hold #hub-panel when open) -->
    <div id="hub-modal" class="modal" aria-hidden="true">
      <div class="modal-backdrop" data-close-modal></div>
      <div class="modal-content" role="dialog" aria-modal="true" aria-label="Find pickup hubs">
        <button class="modal-close" type="button" aria-label="Close modal" data-close-modal>&times;</button>
        <div id="modal-hub-container"></div>
      </div>
    </div>

    <section class="order-section" id="order-form">
      <h3 class="section-title">Order Details</h3>
      <p class="order-desc">Please provide your contact details and pickup information. Our team will confirm stock and contact you within 10–15 minutes to finalise the order.</p>
      <form name="order-info" class="order-form" data-netlify="true">
        <input type="hidden" name="form-name" value="order-info" />
        <label class="full-width">
          Product selected
          <input type="text" name="product" id="order-product" placeholder="e.g. Stardawg" required />
        </label>
        <label>
          Full name
          <input type="text" name="name" placeholder="Your full name" required />
        </label>
        <label>
          Phone
          <input type="tel" name="phone" placeholder="07712345678" inputmode="numeric" pattern="^07\d{9}$" title="Enter an 11-digit UK mobile number starting with 07" required />
        </label>
        <label>
          Email
          <input type="email" name="email" placeholder="For order confirmation" required />
        </label>
        <label class="full-width" id="order-postcode-block">
          Postcode
          <div id="order-postcode-controls" style="display:flex;gap:8px;align-items:center;margin-top:6px;">
            <input type="text" id="order-postcode" placeholder="Enter postcode" />
            <button type="button" id="order-station-search-btn" class="step-action" title="Search nearest hubs by postcode">Find hubs</button>
          </div>
          <p style="margin-top:10px;color:#d5d9ff;">Enter a postcode to discover nearby 24/7 pickup hubs.</p>
          <p style="margin-top:6px;color:#aeb3d9;">Showing available 24/7 pickup hubs. Enter your postcode to find the closest locations.</p>
          <input type="hidden" name="address" id="order-station" value="" />
          <input type="hidden" name="hubId" id="order-hubId" value="" />
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
            <div id="order-station-summary" style="color:#cfe1ff;font-weight:600"></div>
            <button type="button" id="order-station-change-btn" class="step-action" style="display:none;padding:6px 10px;font-size:0.9rem;">Change</button>
          </div>

          <!-- Pickup timing options (shown after hub selection) -->
          <div id="pickup-options" style="display:none;margin-top:14px;">
            <label style="color:#e6f1ff;font-weight:700;display:block;margin-bottom:8px;">When would you like to collect your order?</label>
            <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
              <label style="display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);">
                <input type="radio" name="pickup" value="same-day" data-surcharge="30" />
                <span style="font-weight:600;">Same day</span>
                <small style="margin-left:6px;color:#9ba3d8">+£30 — Express collection</small>
              </label>
              <label style="display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);">
                <input type="radio" name="pickup" value="next-day" data-surcharge="20" />
                <span style="font-weight:600;">Next day</span>
                <small style="margin-left:6px;color:#9ba3d8">+£20 — Priority collection</small>
              </label>
              <label style="display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);">
                <input type="radio" name="pickup" value="standard" data-surcharge="0" checked />
                <span style="font-weight:600;">3–5 days</span>
                <small style="margin-left:6px;color:#9ba3d8">Free — Standard collection</small>
              </label>
            </div>
            <input type="hidden" name="pickupOption" id="pickup-option" value="standard" />
            <input type="hidden" name="pickupSurcharge" id="pickup-surcharge" value="0" />
          </div>
        </label>
        <label class="full-width">
          Notes / Special requests
          <textarea name="notes" rows="4" placeholder="Flavour, quantity or special requests"></textarea>
        </label>
        <button type="submit" class="submit-order">Submit order</button>
      </form>
      <div id="verification-banner" class="verification-banner" style="display:none;">
        <p class="verification-text">
          We've emailed a verification link to <strong id="verification-email">your email</strong>.
          Delivery can take 1–3 minutes — please check your inbox and spam folder.
        </p>
        <div class="verification-actions">
          <button id="verification-resend" type="button">Resend link</button>
          <span id="verification-status" data-tone="muted"></span>
        </div>
      </div>
      <!-- Admin tools removed from homepage -->
      <div id="payment-section" class="payment-section" aria-live="polite" style="display:none;margin-top:18px;">
        <h4>Payment methods</h4>
        <p id="payment-hint">Order created. Select a payment network to generate a payment link.</p>
        <div id="payment-actions" class="pay-grid">
          <button id="pay-trc20" class="step-action pay-option" type="button">
            <span class="token-icon tron">T</span>
            <span class="token-copy">
              <strong>USDT • TRC20</strong>
              <small>Lower network fee — recommended</small>
            </span>
          </button>
          <button id="pay-erc20" class="step-action pay-option" type="button">
            <span class="token-icon eth">T</span>
            <span class="token-copy">
              <strong>USDT • ERC20</strong>
              <small>Ethereum network (higher gas)</small>
            </span>
          </button>
          <button id="pay-bank" class="step-action pay-option" type="button">
            <span class="token-icon bank">£</span>
            <span class="token-copy">
              <strong>Bank transfer</strong>
              <small>Use the reference code to complete payment</small>
            </span>
          </button>
        </div>
        <div id="bank-details" style="display:none;margin-top:12px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);max-width:640px;">
          <div style="display:flex;flex-direction:column;gap:6px;color:#e6f1ff;">
            <div><strong>Account Name：</strong> Haige Wang</div>
            <div><strong>Sort Code：</strong> 08-08-08</div>
            <div><strong>Account Number：</strong> 54685685</div>
            <p style="margin-top:8px;color:#cfe1ff;">Reference: <span id="bank-ref-example">W0XPSN</span></p>
          </div>
        </div>
        <div id="invoice-box" style="margin-top:12px;display:none;">
          <p id="invoice-info"></p>
          <a id="invoice-link" class="btn-primary" href="#" target="_blank" rel="noopener">Proceed to payment</a>
          <p id="waiting-note" style="margin-top:8px;">Please wait after payment; your order status will update when confirmation is received.</p>
          <p id="order-status" style="font-weight:600;margin-top:8px;"></p>
        </div>
      </div>
      <p class="order-hint">Orders are reviewed manually; if you need expedited assistance please contact support via the site footer.</p>
    </section>

    <section class="stations-section" id="stations">
      <h3 class="section-title">All 24/7 Hubs</h3>
      <div class="station-controls">
        <input id="station-search" type="text" placeholder="Enter city / address / postcode" />
        <span class="station-count" id="station-count" aria-live="polite">Loading…</span>
      </div>
      <div class="station-list" id="station-list" aria-live="polite"></div>
    </section>

    <footer id="contact">
      © 2026 Green Hub Northern Ireland · Adults only (18+) | <a href="#">Privacy Policy</a> | <a href="#">Contact Us</a>
    </footer>

    <!-- Floating contact buttons: Telegram & WhatsApp -->
    <div id="floating-contact" aria-hidden="false">
      <div class="fc-label">Live chat</div>
      <a class="fc-button" id="fc-telegram" href="#" target="_blank" rel="noopener" aria-label="Live chat on Telegram" title="Live chat on Telegram">
        <img class="fc-img" src="uploads/telegram.png" alt="Telegram" loading="lazy" />
      </a>
      <a class="fc-button" id="fc-whatsapp" href="#" target="_blank" rel="noopener" aria-label="Live chat on WhatsApp" title="Live chat on WhatsApp">
        <img class="fc-img" src="uploads/whatsapp.png" alt="WhatsApp" loading="lazy" />
      </a>
    </div>
  </div>

  <!-- Product image modal -->
  <div id="image-modal" class="img-modal" aria-hidden="true">
    <div class="img-modal-backdrop" data-close-img></div>
    <figure class="img-modal-content" role="dialog" aria-modal="true" aria-label="Product image preview">
      <button class="img-modal-close" type="button" aria-label="Close" data-close-img>&times;</button>
      <img id="img-modal-image" src="" alt="Product image preview" loading="lazy" />
      <figcaption id="img-modal-caption" class="img-modal-caption"></figcaption>
    </figure>
  </div>

  <script>
    const HUBS_ENDPOINT = '/.netlify/functions/stations';
    const STATIONS_SOURCE = 'data/hubs-ni.json';
    let hubMap = null;
    let hubMarkers = [];
    let userMarker = null;
    let leafletReadyPromise = null;
    let allStations = [];
    let stationListReady = false;
    let stationSearchValue = '';

    function goToOrderForm(productName, variantText) {
      const orderSection = document.getElementById('order-form');
      if (orderSection) {
        orderSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      const productInput = document.getElementById('order-product');
      if (productInput && productName) {
        productInput.value = variantText ? `${productName} · ${variantText}` : productName;
        try { productInput.focus({ preventScroll: true }); } catch(e) { productInput.focus(); }
      }
    }

    function initVariantSelectionClicks() {
      document.addEventListener('click', (event) => {
        const target = event.target.closest('.variant-row, .variant-card');
        if (!target) return;
        const product = target.dataset.product;
        const variant = target.dataset.variant;
        goToOrderForm(product, variant);
        if (target.classList.contains('variant-card')) {
          document.querySelectorAll('.variant-card.active').forEach((card) => card.classList.remove('active'));
          target.classList.add('active');
        }
      });
    }

    function applyStationSelection(stationId, stationName, stationAddress, stationPostcode) {
      const formSection = document.getElementById('order-form');
      if (formSection) {
        formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      // Fill hidden address field and update visible summary
      const stationInput = document.getElementById('order-station');
      const summaryEl = document.getElementById('order-station-summary');
      const postcodeControls = document.getElementById('order-postcode-controls');
      const hubIdInput = document.getElementById('order-hubId');
      const changeBtn = document.getElementById('order-station-change-btn');
      const postcodeInput = document.getElementById('order-postcode');
      if (stationInput) {
        const summary = [stationName, stationAddress, stationPostcode].filter(Boolean).join(' · ');
        stationInput.value = summary;
        if (summaryEl) summaryEl.textContent = summary;
        // hide postcode input and show only summary + change control
        try { if (postcodeControls) postcodeControls.style.display = 'none'; } catch(e) {}
        try { if (changeBtn) changeBtn.style.display = 'inline-block'; } catch(e) {}
        if (postcodeInput && stationPostcode) postcodeInput.value = stationPostcode;
        if (hubIdInput) hubIdInput.value = stationId || '';
        // Show pickup timing options when a hub is selected
        try {
          const pickupBlock = document.getElementById('pickup-options');
          const defaultRadio = document.querySelector('input[name="pickup"][value="standard"]');
          const pickupHidden = document.getElementById('pickup-surcharge');
          const pickupOptHidden = document.getElementById('pickup-option');
          if (pickupBlock) pickupBlock.style.display = 'block';
          if (defaultRadio) {
            defaultRadio.checked = true;
            if (pickupHidden) pickupHidden.value = defaultRadio.dataset.surcharge || '0';
            if (pickupOptHidden) pickupOptHidden.value = defaultRadio.value || 'standard';
          }
        } catch (e) { console.warn('show pickup options failed', e); }
          try { console.log('applyStationSelection -> hub set', { stationId, hubId: hubIdInput ? hubIdInput.value : null, stationName, stationPostcode }); } catch(e) {}
      }
    }

    function toggleHubPanel() {
      const panel = document.getElementById('hub-panel');
      if (!panel) return;
      panel.classList.toggle('active');
    }

    /* ------------------- Navigation indicator ------------------- */
    function initNavIndicator() {
      const menu = document.getElementById('nav-menu');
      const indicator = document.getElementById('nav-indicator');
      if (!menu || !indicator) return;
      const links = Array.from(menu.querySelectorAll('a'));

      function moveIndicator(target) {
        if (!target) return;
        const { offsetLeft, offsetWidth } = target;
        indicator.style.transform = `translateX(${offsetLeft}px)`;
        indicator.style.width = `${offsetWidth}px`;
      }

      moveIndicator(menu.querySelector('a.active'));

      links.forEach((link) => {
        link.addEventListener('click', () => {
          links.forEach((l) => l.classList.remove('active'));
          link.classList.add('active');
          moveIndicator(link);
        });
      });

      const sectionMap = links
        .map((link) => {
          const id = link.getAttribute('href').replace('#', '');
          return { link, section: document.getElementById(id) };
        })
        .filter((item) => item.section);

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const match = sectionMap.find((item) => item.section === entry.target);
              if (match) {
                links.forEach((l) => l.classList.remove('active'));
                match.link.classList.add('active');
                moveIndicator(match.link);
              }
            }
          });
        },
        { threshold: 0.4 }
      );

      sectionMap.forEach((item) => observer.observe(item.section));
    }

    /* ------------------- Stations list overview ------------------- */
    function cleanStationName(name = '') {
      return name.replace(/^OOHPod\s*/i, '').trim() || 'GreenHub Locker';
    }

    function renderStationSkeleton(count = 6) {
      const list = document.getElementById('station-list');
      if (!list) return;
      const skeletonCard = `
        <div class="station-card">
          <div class="skeleton-line" style="width:55%"></div>
          <div class="skeleton-line" style="width:90%"></div>
          <div class="skeleton-line" style="width:72%"></div>
        </div>`;
      list.innerHTML = new Array(count).fill(skeletonCard).join('');
      const countEl = document.getElementById('station-count');
      if (countEl) countEl.textContent = 'Loading…';
    }

    function renderStationCards(items) {
      const list = document.getElementById('station-list');
      const countEl = document.getElementById('station-count');
      if (!list) return;
      if (!items.length) {
        list.innerHTML = '<p class="hub-note">No matching hubs found. Please refine your search.</p>';
      } else {
        list.innerHTML = items
          .map(
            (station, index) => `
            <div class="station-card" style="animation-delay:${index * 40}ms">
              <small>${cleanStationName(station.name)}</small>
              <p>${station.address}</p>
              <span>${station.postcode}</span>
            </div>`
          )
          .join('');
      }
      if (countEl) {
        countEl.textContent = `${items.length} / ${allStations.length} hubs`;
      }
    }

    function filterStations(query) {
      const normalized = query.trim().toLowerCase();
      if (!normalized) return allStations;
      return allStations.filter((station) => {
        const target = `${station.name} ${station.address} ${station.postcode}`.toLowerCase();
        return target.includes(normalized);
      });
    }

    async function loadStationList() {
      if (stationListReady) return;
      renderStationSkeleton();
      try {
        const response = await fetch(STATIONS_SOURCE);
        if (!response.ok) throw new Error('Failed to load hub data');
        allStations = await response.json();
        stationListReady = true;
        renderStationCards(filterStations(stationSearchValue));
      } catch (error) {
        console.error('station list load error', error);
        const list = document.getElementById('station-list');
        if (list) {
          list.innerHTML = '<p class="hub-note">Hub list temporarily unavailable, please refresh later.</p>';
        }
        const countEl = document.getElementById('station-count');
        if (countEl) countEl.textContent = 'Load failed';
      }
    }

    function initStationSearch() {
      const searchInput = document.getElementById('station-search');
      if (!searchInput) return;
      searchInput.addEventListener('input', () => {
        stationSearchValue = searchInput.value;
        renderStationCards(filterStations(stationSearchValue));
      });
    }

    function waitForLeaflet() {
      if (window.L) return Promise.resolve(window.L);
      if (!leafletReadyPromise) {
        leafletReadyPromise = new Promise((resolve, reject) => {
          const deadline = setTimeout(() => reject(new Error('Leaflet failed to load')), 8000);
          const check = () => {
            if (window.L) {
              clearTimeout(deadline);
              resolve(window.L);
            } else {
              requestAnimationFrame(check);
            }
          };
          check();
        });
      }
      return leafletReadyPromise;
    }

    function clearDynamicNotes(card) {
      card.querySelectorAll('.hub-note.dynamic').forEach((note) => note.remove());
    }

    function updateDynamicNote(card, text) {
      if (!text) return;
      const note = document.createElement('p');
      note.className = 'hub-note dynamic';
      note.textContent = text;
      card.appendChild(note);
    }

    async function renderHubMap(user, stations) {
      const mapContainer = document.getElementById('hub-map');
      if (!mapContainer || !stations.length || !user) {
        if (mapContainer) mapContainer.classList.remove('visible');
        return;
      }

      const validStations = stations.filter(
        (station) => Number.isFinite(station.latitude) && Number.isFinite(station.longitude)
      );
      if (!validStations.length) {
        mapContainer.classList.remove('visible');
        return;
      }

      const L = await waitForLeaflet();
      mapContainer.classList.add('visible');

      if (!hubMap) {
        hubMap = L.map('hub-map', {
          zoomControl: false
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(hubMap);
      }

      hubMarkers.forEach((marker) => hubMap.removeLayer(marker));
      hubMarkers = [];
      if (userMarker) {
        hubMap.removeLayer(userMarker);
        userMarker = null;
      }

      const bounds = [];
      const hasUser = Number.isFinite(user.latitude) && Number.isFinite(user.longitude);

      if (hasUser) {
        const userIcon = L.divIcon({
          html: '<div style="width:14px;height:14px;border-radius:50%;background:#7c3aed;border:2px solid white"></div>',
          className: 'user-pin'
        });
        userMarker = L.marker([user.latitude, user.longitude], { icon: userIcon }).addTo(hubMap);
        userMarker.bindPopup(`Your location: ${user.postcode}`);
        bounds.push([user.latitude, user.longitude]);
      }

      validStations.forEach((station, index) => {
        const cleanName = station.name.replace(/^OOHPod\s*/i, '').trim();
        const marker = L.marker([station.latitude, station.longitude]).addTo(hubMap);
        marker.bindPopup(`<strong>${cleanName}</strong><br>${station.address}<br>${station.postcode}`);
        hubMarkers.push(marker);
        bounds.push([station.latitude, station.longitude]);
      });

      if (bounds.length > 1) {
        hubMap.fitBounds(bounds, { padding: [20, 20] });
      } else if (bounds.length === 1) {
        hubMap.setView(bounds[0], 13);
      }
    }

    async function matchHub() {
      const input = document.getElementById('postcode');
      const list = document.getElementById('hub-list');
      const card = document.querySelector('.hub-card');

      if (!input || !list || !card) return;

      const value = input.value.trim().toUpperCase();
      if (!value) {
        alert('Please enter a postcode (e.g. BT9 5AD)');
        input.focus();
        return;
      }

      const postcodePattern = /^([A-Z]{1,2}\d[A-Z\d]? ?\d[A-Z]{2})$/;
      if (!postcodePattern.test(value)) {
        alert('Invalid postcode format. Please enter a UK/NI postcode (e.g. BT9 5AD).');
        input.focus();
        return;
      }

      list.innerHTML = '<li>Searching...</li>';
      clearDynamicNotes(card);

      try {
        const response = await fetch(`${HUBS_ENDPOINT}?postcode=${encodeURIComponent(value)}`);
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data?.error || 'Network error');
        }

        const stations = (data.stations || []).map((station) => ({
          ...station,
          distanceMiles: station.distanceKm ? station.distanceKm * 0.621371 : null
        }));

        if (!stations.length) {
          list.innerHTML = '<li>No matching hubs found. Please check the postcode or try again later.</li>';
          await renderHubMap(null, []);
          return;
        }

        list.innerHTML = stations
          .map((station, _idx) => {
            const distance = station.distanceMiles
              ? `<span class="distance">${station.distanceMiles.toFixed(1)} mi</span>`
              : '';
            const cleanName = station.name.replace(/^OOHPod\s*/i, '').trim();
            const safeName = cleanName.replace(/"/g, '&quot;');
            const safePostcode = station.postcode.replace(/"/g, '&quot;');
            const safeAddress = station.address.replace(/"/g, '&quot;');
            // Ensure we have a stable id. if station.id not provided, derive one from postcode+address
            const derivedId = station.id || (safePostcode + '|' + safeAddress + '|' + _idx);
            return `
              <li class="hub-result" data-station-id="${derivedId}" data-station-name="${safeName}" data-station-postcode="${safePostcode}" data-station-address="${safeAddress}">
                <div>
                  <strong>${cleanName}</strong> — ${station.address} · <span class="distance">${station.postcode}</span> ${distance}
                </div>
                <span class="select-chip">Select this hub to collect</span>
              </li>`;
          })
          .join('');

        // highlight the nearest station visually and scroll it into view
        requestAnimationFrame(() => {
          const items = list.querySelectorAll('.hub-result');
          if (items && items.length) {
            items.forEach((it, idx) => it.classList.toggle('nearest', idx === 0));
            try { items[0].scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (e) {}
          }
        });

        updateDynamicNote(
          card,
          `Based on ${data.user?.postcode || value}, recommending the nearest ${stations.length} hubs.`
        );

        renderHubMap(data.user, stations).catch((err) => {
          console.warn('map render failed', err);
        });
      } catch (error) {
        console.error('matchHub error', error);
        list.innerHTML = '<li>Service temporarily unavailable. Please try again later.</li>';
        await renderHubMap(null, []);
      }
    }

    function initParallax() {
      const elements = document.querySelectorAll('.parallax');
      if (!elements.length) return;
      const handleScroll = () => {
        const scrollY = window.scrollY || window.pageYOffset;
        elements.forEach((el) => {
          const depth = Number(el.dataset.depth || 0.15);
          const offset = scrollY * depth * -0.1;
          el.style.transform = `translate3d(0, ${offset}px, 0)`;
        });
      };
      handleScroll();
      window.addEventListener('scroll', handleScroll, { passive: true });
    }

    function focusProducts(stationName, stationPostcode) {
      const productsSection = document.getElementById('products');
      if (!productsSection) return;
      productsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      productsSection.classList.remove('highlight-pulse');
      void productsSection.offsetWidth;
      productsSection.classList.add('highlight-pulse');

      const header = productsSection.querySelector('h3');
      if (header) {
        header.setAttribute('data-selected-station', `${stationName} · ${stationPostcode}`);
      }
    }

    function scrollToProducts() {
      const productsWrapper = document.querySelector('.product-showcase');
      if (productsWrapper) {
        productsWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function initHubResultClicks() {
      const list = document.getElementById('hub-list');
      if (!list) return;
      list.addEventListener('click', (event) => {
        const item = event.target.closest('.hub-result');
        if (!item) return;
        const id = item.dataset.stationId || '';
        const name = item.dataset.stationName || '';
        const postcode = item.dataset.stationPostcode || '';
        const address = item.dataset.stationAddress || '';
        focusProducts(name, postcode);
        applyStationSelection(id, name, address, postcode);
        // Close the modal after selection; closeHubModal will handle scrolling/focus
        try { if (typeof closeHubModal === 'function') closeHubModal(); } catch (e) { console.warn('closeHubModal failed', e); }
      });
    }

    // Open modal and run postcode match inside it (used from the order form)
    function openHubModalAndSearch(postcode) {
      try {
        openHubModal();
      } catch (e) {
        console.warn('openHubModal not available', e);
      }
      const modalInput = document.querySelector('#hub-modal #postcode') || document.getElementById('postcode');
      if (modalInput && postcode) {
        modalInput.value = String(postcode).trim().toUpperCase();
      }
      // Delay slightly to ensure modal is rendered before matching
      setTimeout(() => {
        try { if (typeof matchHub === 'function') matchHub(); } catch (e) { console.warn(e); }
        // Try to fix Leaflet rendering
        setTimeout(() => { try { if (window.hubMap && typeof window.hubMap.invalidateSize === 'function') window.hubMap.invalidateSize(); } catch (e) {} }, 300);
      }, 150);
    }

    // Bind quick hub search on order form (Enter key or button)
    function initPhoneInputMask() {
      const phoneInput = document.querySelector('input[name="phone"]');
      if (!phoneInput) return;
      phoneInput.addEventListener('input', () => {
        let digits = phoneInput.value.replace(/[^0-9]/g, '');
        if (digits.startsWith('447')) {
          digits = '0' + digits.slice(2);
        } else if (digits.startsWith('44')) {
          digits = '0' + digits.slice(2);
        } else if (digits.startsWith('7')) {
          digits = '0' + digits;
        }
        if (!digits.startsWith('07')) {
          digits = '07' + digits.replace(/^0+/, '');
        }
        phoneInput.value = digits.slice(0, 11);
      });
    }

    function initOrderStationQuickSearch() {
      const orderPostcode = document.getElementById('order-postcode');
      if (!orderPostcode) return;
      const btn = document.getElementById('order-station-search-btn');
      if (btn) btn.addEventListener('click', () => openHubModalAndSearch(orderPostcode.value));
      orderPostcode.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          openHubModalAndSearch(orderPostcode.value);
        }
      });
      const changeBtn = document.getElementById('order-station-change-btn');
      const postcodeControls = document.getElementById('order-postcode-controls');
      const summaryEl = document.getElementById('order-station-summary');
      if (changeBtn) {
        changeBtn.addEventListener('click', () => {
          try { if (postcodeControls) postcodeControls.style.display = ''; } catch(e) {}
          try { changeBtn.style.display = 'none'; } catch(e) {}
          if (summaryEl) summaryEl.textContent = '';
          try { orderPostcode.focus(); } catch(e) {}
        });
      }
    }

    /* ------------------- Order & payment frontend integration ------------------- */
    const sessionStart = Date.now();
    let pageViewCount = 1;

    function trackPageInteraction() {
      pageViewCount += 1;
    }

    function registerInteractionTracking() {
      const selectors = ['.nav-menu a', '.hero-cta button', '#order-station-search-btn', '#order-station-change-btn', '.cta button'];
      selectors.forEach((selector) => {
        document.querySelectorAll(selector).forEach((el) => {
          el.addEventListener('click', trackPageInteraction);
        });
      });
      document.addEventListener('click', (event) => {
        if (event.target.closest('.variant-card') || event.target.closest('.product-card') || event.target.closest('.pay-option') || event.target.closest('#hub-modal .card-link')) {
          trackPageInteraction();
        }
      });
      window.addEventListener('hashchange', trackPageInteraction);
    }

    const verificationState = {
      orderId: null,
      email: '',
      resendTimer: null
    };

    function maskEmailDisplay(email) {
      if (!email || !email.includes('@')) return email || '';
      const [user, domain] = email.split('@');
      const visible = (user || '').slice(0, 2);
      return `${visible}${user && user.length > 2 ? '***' : ''}@${domain || ''}`;
    }

    function setVerificationStatus(message = '', tone = 'muted') {
      const statusEl = document.getElementById('otp-status');
      if (!statusEl) return;
      statusEl.textContent = message;
      statusEl.dataset.tone = tone;
    }

    function updateVerificationEmailLabel() {
      const emailLabel = document.getElementById('otp-email');
      if (!emailLabel) return;
      emailLabel.textContent = verificationState.email ? maskEmailDisplay(verificationState.email) : 'your email';
    }

    function showVerificationReminder(orderId, email) {
      verificationState.orderId = orderId;
      verificationState.email = email || '';
      localStorage.setItem('supply24_orderId', orderId);
      updateVerificationEmailLabel();
      setVerificationStatus('We emailed a secure link to your inbox. Click it to unlock payment options.', 'muted');
      const modal = document.getElementById('otp-modal');
      if (modal) {
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
      }
    }

    function closeVerificationModal() {
      const modal = document.getElementById('otp-modal');
      if (!modal) return;
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
    }

    async function resendVerificationLink(newEmail) {
      if (!verificationState.orderId) return;
      const payload = { orderId: verificationState.orderId };
      const targetEmail = newEmail ? newEmail.trim() : '';
      if (targetEmail) payload.email = targetEmail;
      const button = document.getElementById('otp-resend');
      if (button) button.disabled = true;
      setVerificationStatus('Sending verification email…', 'muted');
      try {
        const resp = await fetch('/.netlify/functions/request-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(data.error || 'Failed to send email');
        if (targetEmail) verificationState.email = targetEmail;
        updateVerificationEmailLabel();
        setVerificationStatus(`Verification link sent to ${maskEmailDisplay(verificationState.email)}`, 'success');
      } catch (err) {
        console.error('resend verification failed', err);
        setVerificationStatus(err.message || 'Could not send email', 'error');
      } finally {
        if (button) {
          clearTimeout(verificationState.resendTimer);
          verificationState.resendTimer = setTimeout(() => {
            button.disabled = false;
          }, 15000);
        }
      }
    }

    function handleSkipVerification() {
      if (!verificationState.orderId) return;
      closeVerificationModal();
      showPaymentSection(verificationState.orderId);
      redirectToPayment(verificationState.orderId);
    }

    function showVerificationReminder(orderId, email) {
      localStorage.setItem('supply24_orderId', orderId);
      const modal = document.getElementById('otp-modal');
      const emailLabel = document.getElementById('otp-email');
      if (emailLabel) {
        const [user, domain] = String(email || '').split('@');
        emailLabel.textContent = email ? `${user?.slice(0, 2)}***@${domain || ''}` : 'your email';
      }
      if (modal) {
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
      }
    }

    function showPaymentSection(orderId) {
      const section = document.getElementById('payment-section');
      const hint = document.getElementById('payment-hint');
      const invoiceBox = document.getElementById('invoice-box');
      const statusEl = document.getElementById('order-status');
      if (!section) return;
      section.style.display = 'block';
      const parts = String(orderId).split('-');
      const suffix = parts[parts.length - 1] || orderId;
      hint.textContent = `Order ${suffix} created. Select a payment network to generate a payment link.`;
      invoiceBox.style.display = 'none';
      statusEl.textContent = '';
      localStorage.setItem('supply24_orderId', orderId);
      closeVerificationModal();
      startOrderPolling(orderId);
    }

    async function resumeOrderFlow(orderId) {
      try {
        const resp = await fetch(`/.netlify/functions/get-order?orderId=${encodeURIComponent(orderId)}`);
        if (!resp.ok) throw new Error('order not found');
        const order = await resp.json();
        if (order.otpVerifiedAt) {
          showPaymentSection(orderId);
          return;
        }
        showVerificationReminder(orderId, order.customerEmail);
      } catch (err) {
        console.warn('resume order failed', err);
        localStorage.removeItem('supply24_orderId');
        localStorage.removeItem('supply24_verified_order');
      }
    }

    async function createPaymentForOrder(orderId, network) {
      const actions = document.getElementById('payment-actions');
      const btnTrc = document.getElementById('pay-trc20');
      const btnErc = document.getElementById('pay-erc20');
      actions && (actions.style.pointerEvents = 'none');
      btnTrc && (btnTrc.textContent = 'Processing...');
      btnErc && (btnErc.textContent = 'Processing...');

      try {
        const resp = await fetch('/.netlify/functions/create-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderId, network })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to create invoice');
        renderInvoice(data);
      } catch (err) {
        alert('Failed to create invoice: ' + (err.message || err));
        console.error(err);
      } finally {
        actions && (actions.style.pointerEvents = '');
        btnTrc && (btnTrc.textContent = 'USDT TRC20');
        btnErc && (btnErc.textContent = 'USDT ERC20');
      }
    }

    function renderInvoice(invoice) {
      const invoiceBox = document.getElementById('invoice-box');
      const info = document.getElementById('invoice-info');
      const link = document.getElementById('invoice-link');
      const statusEl = document.getElementById('order-status');
      if (!invoiceBox || !info || !link) return;
      invoiceBox.style.display = 'block';
      const amountLabel = invoice.payAmount
        ? `${invoice.payAmount} ${invoice.payCurrency || ''}`
        : `${invoice.priceAmount} ${invoice.priceCurrency || ''}`;
      info.innerHTML = `Invoice <strong>${invoice.invoiceId}</strong> · Amount: <strong>${amountLabel}</strong>`;
      if (invoice.payUrl) {
        link.href = invoice.payUrl;
        link.textContent = 'Open payment page';
        link.target = '_blank';
      } else {
        link.removeAttribute('href');
        link.textContent = 'Payment link unavailable';
      }
      statusEl.textContent = 'Waiting for payment confirmation...';
    }

    let _pollTimer = null;
    async function pollOrderOnce(orderId) {
      try {
        const resp = await fetch(`/.netlify/functions/get-order?orderId=${encodeURIComponent(orderId)}`);
        if (!resp.ok) return null;
        const order = await resp.json();
        return order;
      } catch (err) {
        console.warn('poll error', err);
        return null;
      }
    }

    function startOrderPolling(orderId) {
      if (_pollTimer) clearInterval(_pollTimer);
      const statusEl = document.getElementById('order-status');
      _pollTimer = setInterval(async () => {
        const order = await pollOrderOnce(orderId);
        if (!order) return;
        if (order.status === 'paid') {
          statusEl && (statusEl.textContent = `Paid — ${order.paidAt || ''}`);
          clearInterval(_pollTimer);
          _pollTimer = null;
        }
      }, 5000);
    }

    async function loadChatLinks() {
      try {
        const resp = await fetch('/data/chat-links.json');
        if (!resp.ok) return;
        const links = await resp.json();
        const tg = document.getElementById('fc-telegram');
        const wa = document.getElementById('fc-whatsapp');
        const payTg = document.getElementById('livechat-tg');
        const payWa = document.getElementById('livechat-wa');
        if (tg && links.telegram) tg.href = links.telegram;
        if (wa && links.whatsapp) wa.href = links.whatsapp;
        if (payTg && links.telegram) payTg.href = links.telegram;
        if (payWa && links.whatsapp) payWa.href = links.whatsapp;
      } catch (err) {
        console.warn('chat links load failed', err);
      }
    }
    loadChatLinks();

    function initProductImagePreview() {
      const container = document.getElementById('product-showcase');
      const modal = document.getElementById('image-modal');
      const modalImg = document.getElementById('img-modal-image');
      const modalCaption = document.getElementById('img-modal-caption');
      if (!container || !modal || !modalImg) return;

      function closeModal() {
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        modalImg.src = '';
        modalCaption && (modalCaption.textContent = '');
        document.body.style.overflow = '';
      }

      function openModal(src, caption) {
        modalImg.src = src;
        modalImg.alt = caption || 'Product image';
        if (modalCaption) modalCaption.textContent = caption || '';
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }

      container.addEventListener('click', (event) => {
        const thumb = event.target.closest('.product-gallery-thumb');
        if (thumb) {
          const gallery = thumb.closest('.product-gallery');
          const mainImg = gallery?.querySelector('img');
          if (gallery && mainImg) {
            const src = thumb.dataset.src;
            mainImg.src = src;
            gallery.querySelectorAll('.product-gallery-thumb').forEach((btn) => btn.classList.remove('active'));
            thumb.classList.add('active');
          }
          return;
        }

        const modalTrigger = event.target.closest('.product-gallery img, .variant-card img');
        const fallbackImg = event.target.closest('.product-card img');
        const img = modalTrigger || fallbackImg;
        if (!img) return;
        const title = img.closest('.product-card')?.querySelector('.stardawg-title')?.textContent?.trim() || img.alt || 'Product image';
        openModal(img.src, title);
      });

      modal.addEventListener('click', (event) => {
        if (event.target.dataset.closeImg !== undefined || event.target === modal) {
          closeModal();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && modal.classList.contains('show')) {
          closeModal();
        }
      });
    }

    function bindOrderForm() {
      const form = document.querySelector('form[name="order-info"]');
      if (!form) return;
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        // Calculate product base price and add pickup surcharge so checkout settles both together
        const prodText = formData.get('product') || '';
        let basePrice = 0;
        const priceMatch = prodText.toString().match(/£([0-9,\.]+)/);
        if (priceMatch && priceMatch[1]) {
          basePrice = Number(String(priceMatch[1]).replace(/,/g, '')) || 0;
        }
        const pickupSurcharge = Number(formData.get('pickupSurcharge') || 0);
        const totalPrice = basePrice + pickupSurcharge;

        const phoneInput = form.querySelector('input[name="phone"]');
        const rawPhone = (formData.get('phone') || '').toString().replace(/\s+/g, '');
        const phoneValid = /^07\d{9}$/.test(rawPhone);
        if (!phoneValid) {
          alert('Please enter an 11-digit UK mobile number starting with 07');
          if (phoneInput) {
            try { phoneInput.focus(); } catch (e) {}
          }
          return;
        }

        const emailInput = form.querySelector('input[name="email"]');
        const emailValue = (formData.get('email') || '').toString().trim();
        if (!emailValue) {
          alert('Please enter your email address to receive the verification code');
          if (emailInput) {
            try { emailInput.focus(); } catch (e) {}
          }
          return;
        }

        const timeOnPageMs = Date.now() - sessionStart;
        const clientMeta = {
          userAgent: navigator.userAgent || '',
          language: navigator.language || '',
          platform: navigator.platform || '',
          timezone: (Intl.DateTimeFormat().resolvedOptions().timeZone) || '',
          timeOnPageMs,
          pageViewCount,
          referrer: document.referrer || '',
          screen: `${window.screen?.width || 0}x${window.screen?.height || 0}`,
          window: `${window.innerWidth || 0}x${window.innerHeight || 0}`
        };

        const payload = {
          productId: (prodText || '').toString().split(' ')[0] || formData.get('product'),
          productName: prodText,
          basePriceGbp: basePrice,
          priceGbp: totalPrice,
          hubId: formData.get('hubId') || '',
          hubName: formData.get('address'),
          hubPostcode: '',
          customerName: formData.get('name'),
          customerPhone: rawPhone,
          customerEmail: emailValue,
          notes: formData.get('notes'),
          pickupOption: formData.get('pickupOption') || formData.get('pickup') || '',
          pickupSurcharge: pickupSurcharge
        };
        payload.clientMeta = clientMeta;

        if (!payload.hubId) {
          alert('Please select a pickup hub before submitting your order.');
          const changeBtn = document.getElementById('order-station-change-btn');
          try { if (changeBtn) changeBtn.click(); } catch (e) {}
          const stationSearchBtn = document.getElementById('order-station-search-btn');
          try { (stationSearchBtn || document.getElementById('order-postcode')).scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (e) {}
          try { (stationSearchBtn || document.getElementById('order-postcode')).focus(); } catch (e) {}
          return;
        }

        const submitBtn = form.querySelector('.submit-order');
        submitBtn && (submitBtn.disabled = true);
        submitBtn && (submitBtn.textContent = 'Creating order...');

        try {
          try { console.log('create-order payload', payload); } catch(e) {}
          const resp = await fetch('/.netlify/functions/create-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          try { console.log('create-order http status', resp.status, resp.statusText); } catch(e) {}
          let data;
          try {
            data = await resp.json();
            try { console.log('create-order json response', data); } catch(e) {}
          } catch (parseErr) {
            const txt = await resp.text().catch(() => 'Unable to read response');
            console.error('create-order non-JSON response', resp.status, txt);
            try { console.log('create-order raw response text', txt); } catch(e) {}
            throw new Error(txt || `HTTP ${resp.status}`);
          }
          if (!resp.ok) throw new Error(data.error || 'Order failed');
          localStorage.setItem('supply24_orderId', data.orderId);
          showVerificationReminder(data.orderId, payload.customerEmail);
          try { window.location.href = `payment.html?orderId=${encodeURIComponent(data.orderId)}`; } catch (e) {
            console.warn('payment redirect failed', e);
          }
          return;
        } catch (err) {
          alert('Order failed: ' + (err.message || err));
          console.error(err);
        } finally {
          submitBtn && (submitBtn.disabled = false);
          submitBtn && (submitBtn.textContent = 'Submit order');
        }
      });

        // payment buttons
      const btnTrc = document.getElementById('pay-trc20');
      const btnErc = document.getElementById('pay-erc20');
      const btnBank = document.getElementById('pay-bank');
      const bankDetails = document.getElementById('bank-details');
      const bankRefExample = document.getElementById('bank-ref-example');
      btnTrc && btnTrc.addEventListener('click', () => {
        const id = localStorage.getItem('supply24_orderId');
        if (!id) return alert('Please create an order first');
        createPaymentForOrder(id, 'TRC20');
      });
      btnErc && btnErc.addEventListener('click', () => {
        const id = localStorage.getItem('supply24_orderId');
        if (!id) return alert('Please create an order first');
        createPaymentForOrder(id, 'ERC20');
      });
      if (btnBank) {
        btnBank.addEventListener('click', () => {
          const id = localStorage.getItem('supply24_orderId') || '';
          // show only the ID suffix (part after last dash)
          if (bankRefExample) {
            if (id) {
              const parts = String(id).split('-');
              bankRefExample.textContent = parts[parts.length - 1] || id;
            } else {
              bankRefExample.textContent = bankRefExample.textContent || 'W0XPSN';
            }
          }
          if (bankDetails) {
            bankDetails.style.display = 'block';
            try { bankDetails.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (e) {}
          }
        });
      }

      // pickup option wiring: update hidden fields when radio selection changes
      try {
        const pickupRadios = document.querySelectorAll('input[name="pickup"]');
        const pickupHidden = document.getElementById('pickup-surcharge');
        const pickupOptHidden = document.getElementById('pickup-option');
        if (pickupRadios && pickupRadios.length && pickupHidden && pickupOptHidden) {
          pickupRadios.forEach((r) => {
            r.addEventListener('change', () => {
              pickupHidden.value = r.dataset.surcharge || '0';
              pickupOptHidden.value = r.value || '';
            });
          });
        }
      } catch (e) {
        console.warn('pickup wiring failed', e);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      bindOrderForm();
      try { initPhoneInputMask(); } catch (e) { console.warn('initPhoneInputMask failed', e); }
      try { registerInteractionTracking(); } catch (e) { console.warn('registerInteractionTracking failed', e); }
      const prev = localStorage.getItem('supply24_orderId');
      if (prev) {
        resumeOrderFlow(prev).catch((err) => console.warn('resumeOrderFlow failed', err));
      }
      const otpClose = document.getElementById('otp-close');
      if (otpClose) otpClose.addEventListener('click', (e) => { e.preventDefault(); closeVerificationModal(); });
      // Bind quick search button and Enter key on order form
      try { initOrderStationQuickSearch(); } catch (e) { console.warn('initOrderStationQuickSearch failed', e); }
      // Support Enter key on postcode input inside modal to trigger matching
      const modalPostcode = document.getElementById('postcode');
      if (modalPostcode) {
        modalPostcode.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            try { matchHub(); } catch (err) { console.warn(err); }
          }
        });
      }
      // Load products from data file and render
      try { loadAndRenderProducts(); } catch (err) { console.warn('load products failed', err); }
      // Enable product image zoom
      try { initProductImagePreview(); } catch (err) { console.warn('initProductImagePreview failed', err); }
      // Admin tools bindings
      try { initAdminTools(); } catch (e) { console.warn('initAdminTools failed', e); }
      const otpResend = document.getElementById('otp-resend');
      if (otpResend) {
        otpResend.addEventListener('click', (e) => { e.preventDefault(); resendVerificationLink().catch(() => {}); });
      }
      const otpSkip = document.getElementById('otp-skip');
      if (otpSkip) {
        otpSkip.addEventListener('click', (e) => { e.preventDefault(); handleSkipVerification(); });
      }
    });

    // Admin tools: client-side handler to call admin-update-order function
    function initAdminTools() {
      const toggle = document.getElementById('admin-toggle');
      const body = document.getElementById('admin-tools-body');
      const sendBtn = document.getElementById('admin-send-btn');
      const result = document.getElementById('admin-result');
      if (toggle && body) {
        toggle.addEventListener('click', () => { body.style.display = body.style.display === 'none' ? 'flex' : 'none'; });
      }
      if (!sendBtn) return;
      sendBtn.addEventListener('click', async () => {
        try {
          const orderIdInput = document.getElementById('admin-orderId');
          const tracking = document.getElementById('admin-tracking')?.value || '';
          const password = document.getElementById('admin-password')?.value || '';
          const sendEmail = !!document.getElementById('admin-send-email')?.checked;
          let orderId = orderIdInput && orderIdInput.value ? orderIdInput.value.trim() : null;
          if (!orderId) orderId = localStorage.getItem('supply24_orderId') || '';
          if (!orderId) {
            result.textContent = 'No orderId provided (enter or create order first)';
            return;
          }
          result.textContent = 'Sending…';
          const resp = await fetch('/.netlify/functions/admin-update-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId, trackingNumber: tracking, password, sendEmail })
          });
          const data = await resp.json();
          if (!resp.ok) {
            result.textContent = `Error: ${data.error || resp.statusText}`;
            return;
          }
          result.textContent = data.ok ? `Updated ${data.orderId}. Email sent: ${data.emailSent}` : `Failed: ${JSON.stringify(data)}`;
        } catch (err) {
          console.error('admin update failed', err);
          result.textContent = 'Request failed — see console';
        }
      });
      const shareBtn = document.getElementById('admin-share-telegram');
      if (shareBtn) {
        shareBtn.addEventListener('click', async () => {
          try {
            let orderId = document.getElementById('admin-orderId')?.value?.trim() || localStorage.getItem('supply24_orderId') || '';
            if (!orderId) {
              result.textContent = 'No orderId provided (enter or create order first)';
              return;
            }
            result.textContent = 'Preparing share message…';
            const resp = await fetch(`/.netlify/functions/get-order?orderId=${encodeURIComponent(orderId)}`);
            if (!resp.ok) {
              result.textContent = `Failed to load order ${orderId}`;
              return;
            }
            const order = await resp.json();
            const lines = [];
            lines.push(`Order: ${order.orderId}`);
            lines.push(`Product: ${order.productName} (£${order.priceGbp})`);
            lines.push(`Hub: ${order.hubName}`);
            lines.push(`Name: ${order.customerName}`);
            lines.push(`Phone: ${order.customerPhone}`);
            if (order.customerEmail) lines.push(`Email: ${order.customerEmail}`);
            if (order.notes) lines.push(`Notes: ${order.notes}`);
            const text = lines.join('\n');
            const shareUrl = `https://t.me/share/url?text=${encodeURIComponent(text)}`;
            window.open(shareUrl, '_blank');
            result.textContent = 'Opened Telegram share window (choose recipient in Telegram).';
          } catch (err) {
            console.error('share telegram failed', err);
            result.textContent = 'Share failed — see console';
          }
        });
      }
    }

    /* ------------------- Products dynamic renderer ------------------- */
    async function loadAndRenderProducts() {
      const container = document.getElementById('product-showcase');
      if (!container) return;
      container.innerHTML = '<p class="hub-note">Loading products…</p>';
      try {
        const resp = await fetch('data/products.json');
        if (!resp.ok) throw new Error('Failed to load products');
        const data = await resp.json();
        const products = Array.isArray(data.products) ? data.products : data;
        if (!products || !products.length) {
          container.innerHTML = '<p class="hub-note">No products found.</p>';
          return;
        }
        container.innerHTML = products
          .filter(p => p.active !== false)
          .map((p) => renderProductCard(p)).join('');
      } catch (err) {
        console.error('render products error', err);
        container.innerHTML = '<p class="hub-note">Products temporarily unavailable.</p>';
      }
    }

    function safeFormatGbp(val) {
      const n = Number(String(val).replace(/[^0-9.-]/g, '')) || 0;
      return n.toLocaleString('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 });
    }

    function renderProductCard(p) {
      const gallery = Array.isArray(p.images) ? p.images.filter(Boolean) : [];
      if ((!gallery || !gallery.length) && p.image) gallery.push(p.image);
      if ((!gallery || !gallery.length) && p.flag) gallery.push(p.flag);
      const primaryImage = gallery.length ? gallery[0] : '';
      const imgAlt = p.image_alt || `${p.name || ''} image`;
      const countryFlag = p.flag ? `<img class="inline-flag" src="${p.flag}" alt="flag"/>` : '';
      const header = `<h4 class="stardawg-title">${escapeHtml(p.name || '')} ${countryFlag}</h4>`;
      const imgTag = primaryImage ? `<img src="${primaryImage}" alt="${escapeHtml(imgAlt)}" loading="lazy" />` : '';
      const variants = Array.isArray(p.variants) ? p.variants : [];

      function formatGbpDecimals(val, digits = 2) {
        const n = Number(val) || 0;
        return n.toLocaleString('en-GB', { style: 'currency', currency: 'GBP', minimumFractionDigits: digits, maximumFractionDigits: digits });
      }

      const variantViews = variants.map(v => {
        function parsePriceField(x) {
          if (x == null) return 0;
          if (typeof x === 'number') return x;
          const cleaned = String(x).replace(/[^0-9.-]/g, '');
          const n = Number(cleaned);
          return Number.isFinite(n) ? n : 0;
        }

        const price = parsePriceField(v.price_gbp ?? v.price ?? v.priceGbp ?? v.price_gbp);
        const priceFmt = safeFormatGbp(price);

        let gramsValue = null;
        if (v.grams != null && !Number.isNaN(Number(v.grams))) gramsValue = Number(v.grams);
        const labelText = String(v.label || '').trim();
        if (gramsValue == null) {
          const gramsMatch = labelText.match(/([0-9]+(?:[.,][0-9]+)?)\s*g/i);
          if (gramsMatch) gramsValue = parseFloat(gramsMatch[1].replace(',', '.')) || null;
        }

        let perGramText = '';
        if (gramsValue && gramsValue > 0) {
          const perGramValue = price / gramsValue;
          perGramText = `${formatGbpDecimals(perGramValue, 2)}/g`;
        }
        if (!perGramText && v.unit) {
          perGramText = escapeHtml(String(v.unit));
        }

        const variantLabel = escapeHtml(labelText || '');
        const dataVariant = `${variantLabel} · ${priceFmt} · ${perGramText}`;
        const row = `<tr class="variant-row" data-product="${escapeHtml(p.name)}" data-variant="${escapeHtml(dataVariant)}">
                  <td>${variantLabel}</td>
                  <td class="price-cell">${priceFmt}</td>
                  <td class="per-gram">${escapeHtml(perGramText)}</td>
                </tr>`;
        const card = `<button type="button" class="variant-card" data-product="${escapeHtml(p.name)}" data-variant="${escapeHtml(dataVariant)}">
            <span class="variant-card-label">${variantLabel}</span>
            <span class="variant-card-price">${priceFmt}</span>
            <span class="variant-card-per">${escapeHtml(perGramText)}</span>
          </button>`;
        return { row, card };
      });

      const rows = variantViews.map((view) => view.row).join('');
      const cards = variantViews.map((view) => view.card).join('');

      return `
        <div class="card product-card">
          ${gallery.length ? `
            <div class="product-gallery" data-product="${escapeHtml(p.id || p.name || '')}">
              <img src="${escapeHtml(gallery[0])}" alt="${escapeHtml(imgAlt)}" loading="lazy" />
              ${gallery.length > 1 ? `
                <div class="product-gallery-thumbs">
                  ${gallery.map((src, idx) => `<button type="button" class="product-gallery-thumb${idx === 0 ? ' active' : ''}" data-src="${escapeHtml(src)}">
                      <img src="${escapeHtml(src)}" alt="${escapeHtml(p.name || '')} ${idx + 1}" loading="lazy" />
                    </button>`).join('')}
                </div>
              ` : ''}
            </div>
          ` : imgTag}
          <div class="product-flag">${p.country ? escapeHtml(p.country) : ''}</div>
          ${header}
          <table class="variant-table" aria-label="${escapeHtml(p.name)} variants">
            <thead>
              <tr><th>Variant</th><th>Price</th><th>Price per g</th></tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
          <div class="variant-cards" aria-label="${escapeHtml(p.name)} mobile variants">
            ${cards}
          </div>
        </div>`;
    }

    function escapeHtml(s) { return String(s).replace(/[&<>"]/g, function(c){ return { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]; }); }

    // Modal open/close helpers for hub picker
    (function() {
      let _originalParent = null;
      let _nextSibling = null;
      // order form is no longer moved into the modal; no original parent tracking needed

      window.openHubModal = function() {
        try { trackPageInteraction(); } catch (e) {}
        const modal = document.getElementById('hub-modal');
        const modalContainer = document.getElementById('modal-hub-container');
        const hubPanel = document.getElementById('hub-panel');
        if (!modal || !modalContainer || !hubPanel) return;
        if (!_originalParent) {
          _originalParent = hubPanel.parentNode;
          _nextSibling = hubPanel.nextSibling;
        }
        modalContainer.appendChild(hubPanel);
        // Note: do NOT move the order form into the modal (keep Order Details on page)
        // ensure panel presents in modal
        hubPanel.classList.add('active');
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
        const input = modal.querySelector('#postcode');
        if (input) {
          input.focus();
          // If the user already entered a postcode, auto-run a match
          const val = input.value && String(input.value).trim();
          if (val) {
            // Small delay to ensure modal has rendered
            setTimeout(() => {
              try {
                if (typeof matchHub === 'function') matchHub();
              } catch (e) {
                console.warn('auto matchHub failed', e);
              }
              // fix leaflet rendering if map exists
              setTimeout(() => {
                try { if (window.hubMap && typeof window.hubMap.invalidateSize === 'function') window.hubMap.invalidateSize(); } catch (e) {}
              }, 300);
            }, 120);
          }
        }
        document.body.style.overflow = 'hidden';
      };

      window.closeHubModal = function() {
        const modal = document.getElementById('hub-modal');
        const hubPanel = document.getElementById('hub-panel');
        if (!modal || !hubPanel) return;
        if (_originalParent) {
          if (_nextSibling) _originalParent.insertBefore(hubPanel, _nextSibling);
          else _originalParent.appendChild(hubPanel);
        }
        // After closing modal, scroll to Order Details and focus first input
        try {
          setTimeout(() => {
            const orderSection = document.getElementById('order-form');
            if (orderSection) {
              try { orderSection.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (e) {}
              const firstInput = orderSection.querySelector('input[name="name"], input, textarea');
              if (firstInput) firstInput.focus({ preventScroll: true });
            }
          }, 140);
        } catch (e) {}
        // remove active state
        hubPanel.classList.remove('active');
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      };

      document.addEventListener('click', (e) => {
        const close = e.target.closest('[data-close-modal]');
        if (close) closeHubModal();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeHubModal();
      });
    })();

    document.addEventListener('DOMContentLoaded', () => {
      initNavIndicator();
      initStationSearch();
      loadStationList();
      initParallax();
      initHubResultClicks();
      initVariantSelectionClicks();
    });
  </script>
  <div id="otp-modal" class="otp-modal" aria-hidden="true">
    <div class="otp-dialog">
      <button id="otp-close" class="otp-close" type="button" aria-label="Close">&times;</button>
      <h3>Email verification</h3>
      <p class="otp-desc">We've emailed a 6-digit code to <span id="otp-email">your inbox</span>. If you don't see it, check your spam folder.</p>
      <input id="otp-code" class="otp-input" type="text" inputmode="numeric" maxlength="6" placeholder="Enter 6-digit code" />
      <div class="otp-actions">
        <button id="otp-submit" class="otp-btn primary" type="button">Verify</button>
        <button id="otp-resend" class="otp-btn ghost" type="button">Resend code</button>
      </div>
      <button id="otp-skip" class="otp-btn link" type="button">Verify later</button>
      <p id="otp-status" class="otp-status" data-tone="muted"></p>
    </div>
  </div>
<style>
    .otp-modal {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.8);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 24px;
    }
    .otp-dialog {
      width: min(420px, 100%);
      background: linear-gradient(180deg, rgba(7,11,22,0.95), rgba(3,5,12,0.98));
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 18px;
      padding: 26px 24px 28px;
      box-shadow: 0 25px 60px rgba(2, 6, 23, 0.7);
      position: relative;
    }
    .otp-close {
      position: absolute;
      top: 12px;
      right: 12px;
      border: none;
      background: rgba(15, 23, 42, 0.6);
      width: 32px;
      height: 32px;
      border-radius: 999px;
      color: #f8fafc;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .otp-desc {
      color: #cbd5f5;
      margin-bottom: 18px;
      line-height: 1.5;
    }
    .otp-input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(2, 6, 23, 0.6);
      color: #f8fafc;
      font-size: 1.2rem;
      text-align: center;
      letter-spacing: 0.3em;
    }
    .otp-actions {
      display: flex;
      gap: 12px;
      margin: 18px 0 8px;
    }
    .otp-btn {
      flex: 1;
      border: none;
      border-radius: 10px;
      padding: 12px 0;
      font-weight: 600;
      cursor: pointer;
    }
    .otp-btn.link {
      display: inline-block;
      margin-top: 8px;
      width: 100%;
      background: none;
      color: #38bdf8;
      border: none;
      text-decoration: underline;
      font-weight: 500;
    }
    .otp-btn.primary {
      background: linear-gradient(135deg, #22d3ee, #14b8a6);
      color: #03131c;
    }
    .otp-btn.ghost {
      background: rgba(15, 23, 42, 0.6);
      color: #cbd5f5;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }
    .otp-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .otp-status {
      min-height: 20px;
      font-size: 0.9rem;
      color: #cbd5f5;
    }
    .otp-status[data-tone='error'] { color: #f87171; }
    .otp-status[data-tone='success'] { color: #34d399; }
    .otp-status[data-tone='muted'] { color: #94a3b8; }
    @media (min-width: 768px) {
      header {
        position: sticky;
        top: 0;
        z-index: 50;
        padding-bottom: 18px;
      }
    }

    @media (max-width: 640px) {
      body { padding: 10px 8px 28px; }
      header h1 { font-size: 1.7rem; }
      header .site-subtitle { font-size: 0.72rem; letter-spacing: 0.08em; }
      .hero { padding: 18px; margin: 18px auto 22px; gap: 16px; }
      .hero-text h2 { font-size: 1.4rem; }
      .hero-cta { width: 100%; justify-content: center; }
      .hero-cta button { flex: 1 1 150px; text-align: center; }
      .nav-menu { flex-wrap: wrap; gap: 12px; font-size: 0.85rem; justify-content: center; }
      .nav-menu a { padding: 6px 10px; }
      .nav-indicator { display: none; }
      .pay-option { flex: 1 1 100%; }
    }
</style>
</body>
</html>
